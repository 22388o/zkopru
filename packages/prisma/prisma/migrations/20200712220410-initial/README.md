# Migration `20200712220410-initial`

This migration has been generated by Wanseob Lim at 7/12/2020, 10:04:10 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."EncryptedWallet" (
"N" integer  NOT NULL ,"algorithm" text  NOT NULL ,"ciphertext" text  NOT NULL ,"id" text  NOT NULL ,"iv" text  NOT NULL ,"kdf" text  NOT NULL ,"keylen" integer  NOT NULL ,"p" integer  NOT NULL ,"r" integer  NOT NULL ,"salt" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Keystore" (
"address" text  NOT NULL ,"encrypted" text  NOT NULL ,"pubKey" text  NOT NULL ,
    PRIMARY KEY ("address"))

CREATE TABLE "public"."Config" (
"address" text  NOT NULL ,"chainId" integer  NOT NULL ,"challengePeriod" integer  NOT NULL ,"id" text  NOT NULL ,"maxUtxoPerTree" text  NOT NULL ,"maxWithdrawalPerTree" text  NOT NULL ,"minimumStake" text  NOT NULL ,"networkId" integer  NOT NULL ,"nullifierTreeDepth" integer  NOT NULL ,"referenceDepth" integer  NOT NULL ,"utxoSubTreeDepth" integer  NOT NULL ,"utxoSubTreeSize" integer  NOT NULL ,"utxoTreeDepth" integer  NOT NULL ,"withdrawalSubTreeDepth" integer  NOT NULL ,"withdrawalSubTreeSize" integer  NOT NULL ,"withdrawalTreeDepth" integer  NOT NULL ,
    PRIMARY KEY ("networkId","chainId","address"))

CREATE TABLE "public"."Proposal" (
"fetched" text   ,"finalized" boolean   ,"hash" text  NOT NULL ,"invalidated" boolean   ,"proposalData" text   ,"proposalNum" integer   ,"proposalTx" text   ,"proposedAt" integer   ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."Block" (
"hash" text  NOT NULL ,"verified" boolean   ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."Header" (
"depositRoot" text  NOT NULL ,"fee" text  NOT NULL ,"hash" text  NOT NULL ,"metadata" text  NOT NULL ,"migrationRoot" text  NOT NULL ,"nullifierRoot" text  NOT NULL ,"parentBlock" text  NOT NULL ,"proposer" text  NOT NULL ,"txRoot" text  NOT NULL ,"utxoIndex" text  NOT NULL ,"utxoRoot" text  NOT NULL ,"withdrawalIndex" text  NOT NULL ,"withdrawalRoot" text  NOT NULL ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."Bootstrap" (
"blockHash" text   ,"id" text  NOT NULL ,"utxoBootstrap" text  NOT NULL ,"utxoTreeIndex" integer  NOT NULL ,"withdrawalBootstrap" text  NOT NULL ,"withdrawalTreeIndex" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."MassDeposit" (
"blockNumber" integer  NOT NULL ,"fee" text  NOT NULL ,"includedIn" text   ,"index" text  NOT NULL ,"merged" text  NOT NULL ,
    PRIMARY KEY ("index"))

CREATE TABLE "public"."Deposit" (
"blockNumber" integer  NOT NULL ,"fee" text  NOT NULL ,"logIndex" integer  NOT NULL ,"note" text  NOT NULL ,"queuedAt" text  NOT NULL ,"transactionIndex" integer  NOT NULL ,
    PRIMARY KEY ("note"))

CREATE TABLE "public"."Utxo" (
"erc20Amount" text   ,"eth" text   ,"hash" text  NOT NULL ,"index" text   ,"nft" text   ,"nullifier" text   ,"pubKey" text   ,"salt" text   ,"status" integer   ,"tokenAddr" text   ,"treeId" text   ,"usedAt" text   ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."Withdrawal" (
"erc20Amount" text  NOT NULL ,"eth" text  NOT NULL ,"fee" text  NOT NULL ,"hash" text  NOT NULL ,"includedIn" text   ,"index" text   ,"nft" text  NOT NULL ,"prepayer" text   ,"pubKey" text   ,"salt" text   ,"siblings" text   ,"status" integer   ,"to" text  NOT NULL ,"tokenAddr" text  NOT NULL ,"treeId" text   ,"withdrawalHash" text  NOT NULL ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."Migration" (
"erc20Amount" text   ,"eth" text   ,"fee" text   ,"hash" text  NOT NULL ,"index" text   ,"nft" text   ,"pubKey" text   ,"salt" text   ,"status" integer   ,"to" text   ,"tokenAddr" text   ,"treeId" text   ,"usedFor" text   ,
    PRIMARY KEY ("hash"))

CREATE TABLE "public"."TreeNode" (
"nodeIndex" text  NOT NULL ,"treeId" text  NOT NULL ,"value" text  NOT NULL ,
    PRIMARY KEY ("treeId","nodeIndex"))

CREATE TABLE "public"."LightTree" (
"block" text   ,"end" text  NOT NULL ,"id" text  NOT NULL ,"index" text  NOT NULL ,"root" text  NOT NULL ,"siblings" text  NOT NULL ,"species" integer  NOT NULL ,"start" text  NOT NULL ,"treeIndex" integer  NOT NULL ,
    PRIMARY KEY ("species","treeIndex"))

CREATE TABLE "public"."NullifierTree" (
"block" text   ,"id" text  NOT NULL ,"root" text  NOT NULL ,"siblings" text  NOT NULL ,"treeIndex" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "Config.id" ON "public"."Config"("id")

CREATE UNIQUE INDEX "Proposal_fetched" ON "public"."Proposal"("fetched")

CREATE UNIQUE INDEX "Bootstrap.blockHash" ON "public"."Bootstrap"("blockHash")

CREATE UNIQUE INDEX "LightTree.id" ON "public"."LightTree"("id")

CREATE UNIQUE INDEX "NullifierTree.treeIndex" ON "public"."NullifierTree"("treeIndex")

ALTER TABLE "public"."Proposal" ADD FOREIGN KEY ("fetched")REFERENCES "public"."Block"("hash") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Block" ADD FOREIGN KEY ("hash")REFERENCES "public"."Header"("hash") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Bootstrap" ADD FOREIGN KEY ("blockHash")REFERENCES "public"."Block"("hash") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Utxo" ADD FOREIGN KEY ("treeId")REFERENCES "public"."LightTree"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Withdrawal" ADD FOREIGN KEY ("treeId")REFERENCES "public"."LightTree"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Migration" ADD FOREIGN KEY ("treeId")REFERENCES "public"."LightTree"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200712220410-initial
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,197 @@
+generator client {
+  provider = "prisma-client-js"
+  output = "../generated/postgres"
+}
+
+datasource postgres {
+  provider = "postgres"
+  url = "***"
+}
+
+model EncryptedWallet {
+  id String @id @default(uuid())
+  ciphertext String
+  iv String
+  algorithm String
+  keylen Int
+  kdf String
+  N Int
+  r Int
+  p Int
+  salt String
+}
+
+model Keystore {
+  address String @id
+  pubKey String
+  encrypted String // stringified json
+}
+
+model Config {
+  id String @unique
+  networkId Int
+  chainId Int
+  address String
+  utxoTreeDepth Int
+  withdrawalTreeDepth Int
+  nullifierTreeDepth Int
+  challengePeriod Int
+  minimumStake String
+  referenceDepth Int
+  maxUtxoPerTree String
+  maxWithdrawalPerTree String
+  utxoSubTreeDepth Int
+  utxoSubTreeSize Int
+  withdrawalSubTreeDepth Int
+  withdrawalSubTreeSize Int
+  @@id([networkId, chainId, address])
+}
+
+model Proposal {
+  hash String @id
+  proposalNum Int?
+  proposedAt Int?
+  proposalTx String? // tx hash
+  proposalData String? // stringified json
+  fetched String?
+  finalized Boolean?
+  invalidated Boolean?
+  block Block? @relation(fields: [fetched], references: [hash])
+}
+
+model Block {
+  hash String @id
+  verified Boolean?
+  header Header @relation(fields: [hash], references: [hash])
+  proposal Proposal
+  bootstrap Bootstrap?
+}
+
+model Header {
+  hash String @id
+  proposer String
+  parentBlock String
+  metadata String
+  fee String
+  utxoRoot String
+  utxoIndex String
+  nullifierRoot String
+  withdrawalRoot String
+  withdrawalIndex String
+  txRoot String
+  depositRoot String
+  migrationRoot String
+}
+
+model Bootstrap {
+  id String @id @default(uuid())
+  blockHash String? @unique
+  utxoTreeIndex Int
+  // utxoBootstrap String[]
+  utxoBootstrap String // jsonified arr : sqlite does not support arr
+  withdrawalTreeIndex Int
+  // withdrawalBootstrap String[]
+  withdrawalBootstrap String //jsonified arr : sqlite does not support arr
+  block Block? @relation(fields: [blockHash], references: [hash])
+}
+
+model MassDeposit {
+  index String @id
+  merged String
+  fee String
+  blockNumber Int
+  includedIn String?
+}
+
+model Deposit {
+  note String @id
+  fee String
+  transactionIndex Int
+  logIndex Int
+  blockNumber Int
+  queuedAt String
+}
+
+model Utxo {
+  hash String @id
+  eth String?
+  pubKey String?
+  salt String?
+  tokenAddr String?
+  erc20Amount String?
+  nft String?
+  status Int?
+  treeId String?
+  index String?
+  nullifier String?
+  usedAt String?
+  tree LightTree? @relation(fields: [treeId], references: [id])
+}
+
+model Withdrawal {
+  hash String @id
+  withdrawalHash String
+  eth String
+  pubKey String?
+  salt String?
+  tokenAddr String
+  erc20Amount String
+  nft String
+  to String
+  fee String
+  status Int?
+  treeId String?
+  index String?
+  includedIn String?
+  prepayer String?
+  siblings String? // stringified str[]
+  tree LightTree? @relation(fields: [treeId], references: [id])
+}
+
+model Migration {
+  hash String @id
+  eth String?
+  pubKey String?
+  salt String?
+  tokenAddr String?
+  erc20Amount String?
+  nft String?
+  to String?
+  fee String?
+  status Int?
+  treeId String?
+  index String?
+  usedFor String?
+  tree LightTree? @relation(fields: [treeId], references: [id])
+}
+
+model TreeNode {
+  treeId String
+  nodeIndex String
+  value String
+  // tree UtxoTree @relation(fields: [treeId], references: [id])
+  @@id([treeId, nodeIndex])
+}
+
+model LightTree {
+  id String @default(uuid()) @unique
+  species Int // 0: utxo 1: withdrawal
+  treeIndex Int
+  block String?
+  // rollup sync data
+  start String
+  end String
+  // rollup snapshot data
+  root String
+  index String
+  siblings String // stringified str[]
+  @@id([species, treeIndex])
+}
+
+model NullifierTree {
+  id String @id @default(uuid())
+  treeIndex Int @unique
+  block String?
+  root String
+  siblings String // stringified str[]
+}
```


