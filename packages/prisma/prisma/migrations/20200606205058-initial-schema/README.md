# Migration `20200606205058-initial-schema`

This migration has been generated by Wanseob Lim at 6/6/2020, 8:50:58 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
PRAGMA foreign_keys=OFF;

CREATE TABLE "quaint"."EncryptedWallet" (
"N" INTEGER NOT NULL  ,"algorithm" TEXT NOT NULL  ,"ciphertext" TEXT NOT NULL  ,"id" TEXT NOT NULL  ,"iv" TEXT NOT NULL  ,"kdf" TEXT NOT NULL  ,"keylen" INTEGER NOT NULL  ,"p" INTEGER NOT NULL  ,"r" INTEGER NOT NULL  ,"salt" TEXT NOT NULL  ,
    PRIMARY KEY ("id"))

CREATE TABLE "quaint"."Keystore" (
"address" TEXT NOT NULL  ,"encrypted" TEXT NOT NULL  ,"pubKey" TEXT NOT NULL  ,
    PRIMARY KEY ("address"))

CREATE TABLE "quaint"."Config" (
"address" TEXT NOT NULL  ,"chainId" INTEGER NOT NULL  ,"challengePeriod" INTEGER NOT NULL  ,"id" TEXT NOT NULL  ,"maxUtxoPerTree" TEXT NOT NULL  ,"maxWithdrawalPerTree" TEXT NOT NULL  ,"minimumStake" TEXT NOT NULL  ,"networkId" INTEGER NOT NULL  ,"nullifierTreeDepth" INTEGER NOT NULL  ,"referenceDepth" INTEGER NOT NULL  ,"utxoSubTreeDepth" INTEGER NOT NULL  ,"utxoSubTreeSize" INTEGER NOT NULL  ,"utxoTreeDepth" INTEGER NOT NULL  ,"withdrawalSubTreeDepth" INTEGER NOT NULL  ,"withdrawalSubTreeSize" INTEGER NOT NULL  ,"withdrawalTreeDepth" INTEGER NOT NULL  ,
    PRIMARY KEY ("networkId","chainId","address"))

CREATE TABLE "quaint"."Proposal" (
"fetched" TEXT   ,"finalized" BOOLEAN   ,"hash" TEXT NOT NULL  ,"invalidated" BOOLEAN   ,"proposalData" TEXT   ,"proposalNum" INTEGER NOT NULL  ,"proposalTx" TEXT NOT NULL  ,"proposedAt" INTEGER NOT NULL  ,
    PRIMARY KEY ("hash"),FOREIGN KEY ("fetched") REFERENCES "Block"("hash") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."Block" (
"hash" TEXT NOT NULL  ,"verified" BOOLEAN   ,
    PRIMARY KEY ("hash"),FOREIGN KEY ("hash") REFERENCES "Header"("hash") ON DELETE CASCADE ON UPDATE CASCADE)

CREATE TABLE "quaint"."Header" (
"depositRoot" TEXT NOT NULL  ,"fee" TEXT NOT NULL  ,"hash" TEXT NOT NULL  ,"metadata" TEXT NOT NULL  ,"migrationRoot" TEXT NOT NULL  ,"nullifierRoot" TEXT NOT NULL  ,"parentBlock" TEXT NOT NULL  ,"proposer" TEXT NOT NULL  ,"txRoot" TEXT NOT NULL  ,"utxoIndex" TEXT NOT NULL  ,"utxoRoot" TEXT NOT NULL  ,"withdrawalIndex" TEXT NOT NULL  ,"withdrawalRoot" TEXT NOT NULL  ,
    PRIMARY KEY ("hash"))

CREATE TABLE "quaint"."Bootstrap" (
"blockHash" TEXT   ,"id" TEXT NOT NULL  ,"utxoBootstrap" TEXT NOT NULL  ,"utxoTreeIndex" INTEGER NOT NULL  ,"withdrawalBootstrap" TEXT NOT NULL  ,"withdrawalTreeIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("id"),FOREIGN KEY ("blockHash") REFERENCES "Block"("hash") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."MassDeposit" (
"blockNumber" INTEGER NOT NULL  ,"fee" TEXT NOT NULL  ,"includedIn" TEXT   ,"index" TEXT NOT NULL  ,"merged" TEXT NOT NULL  ,
    PRIMARY KEY ("index"))

CREATE TABLE "quaint"."Deposit" (
"blockNumber" INTEGER NOT NULL  ,"fee" TEXT NOT NULL  ,"logIndex" INTEGER NOT NULL  ,"note" TEXT NOT NULL  ,"queuedAt" TEXT NOT NULL  ,"transactionIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("note"))

CREATE TABLE "quaint"."Nullifier" (
"index" TEXT NOT NULL  ,"nullified" BOOLEAN NOT NULL  ,
    PRIMARY KEY ("index"))

CREATE TABLE "quaint"."Note" (
"erc20Amount" TEXT   ,"eth" TEXT   ,"fee" TEXT   ,"hash" TEXT NOT NULL  ,"index" TEXT   ,"nft" TEXT   ,"noteType" INTEGER NOT NULL  ,"pubKey" TEXT   ,"salt" TEXT   ,"status" INTEGER   ,"tokenAddr" TEXT   ,"treeId" TEXT   ,"type" INTEGER   ,"withdrawOutTo" TEXT   ,
    PRIMARY KEY ("hash"),FOREIGN KEY ("treeId") REFERENCES "LightTree"("id") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."TreeNode" (
"nodeIndex" TEXT NOT NULL  ,"treeId" TEXT NOT NULL  ,"value" TEXT NOT NULL  ,
    PRIMARY KEY ("treeId","nodeIndex"))

CREATE TABLE "quaint"."LightTree" (
"block" TEXT   ,"end" TEXT NOT NULL  ,"id" TEXT NOT NULL  ,"index" TEXT NOT NULL  ,"root" TEXT NOT NULL  ,"siblings" TEXT NOT NULL  ,"species" INTEGER NOT NULL  ,"start" TEXT NOT NULL  ,"treeIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("species","treeIndex"))

CREATE TABLE "quaint"."NullifierTree" (
"block" TEXT   ,"id" TEXT NOT NULL  ,"root" TEXT NOT NULL  ,"siblings" TEXT NOT NULL  ,"treeIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "quaint"."Config.id" ON "Config"("id")

CREATE UNIQUE INDEX "quaint"."Proposal_fetched" ON "Proposal"("fetched")

CREATE UNIQUE INDEX "quaint"."Bootstrap.blockHash" ON "Bootstrap"("blockHash")

CREATE UNIQUE INDEX "quaint"."LightTree.id" ON "LightTree"("id")

CREATE UNIQUE INDEX "quaint"."NullifierTree.treeIndex" ON "NullifierTree"("treeIndex")

PRAGMA "quaint".foreign_key_check;

PRAGMA foreign_keys=ON;
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200606205058-initial-schema
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,171 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource sqlite {
+  provider = "sqlite"
+  url      = env("DATABASE_URL")
+}
+
+// datasource postgres {
+//   provider = "postgres"
+//   url      = env("POSTGRES_URL")
+// }
+
+model EncryptedWallet {
+  id String @id @default(uuid())
+  ciphertext String
+  iv String
+  algorithm String
+  keylen Int
+  kdf String
+  N Int
+  r Int
+  p Int
+  salt String
+}
+
+model Keystore {
+  address String @id
+  pubKey String
+  encrypted String // stringified json
+}
+
+model Config {
+  id String @unique
+  networkId Int
+  chainId Int
+  address String
+  utxoTreeDepth Int
+  withdrawalTreeDepth Int
+  nullifierTreeDepth Int
+  challengePeriod Int
+  minimumStake String
+  referenceDepth Int
+  maxUtxoPerTree String
+  maxWithdrawalPerTree String
+  utxoSubTreeDepth Int
+  utxoSubTreeSize Int
+  withdrawalSubTreeDepth Int
+  withdrawalSubTreeSize Int
+  @@id([networkId, chainId, address])
+}
+
+model Proposal {
+  hash String @id
+  proposalNum Int
+  proposedAt Int
+  proposalTx String // tx hash
+  proposalData String? // stringified json
+  fetched String?
+  finalized Boolean?
+  invalidated Boolean?
+  block Block? @relation(fields: [fetched], references: [hash])
+}
+
+model Block {
+  hash String @id
+  verified Boolean?
+  header Header @relation(fields: [hash], references: [hash])
+  proposal Proposal
+  bootstrap Bootstrap?
+}
+
+model Header {
+  hash String @id
+  proposer String
+  parentBlock String
+  metadata String
+  fee String
+  utxoRoot String
+  utxoIndex String
+  nullifierRoot String
+  withdrawalRoot String
+  withdrawalIndex String
+  txRoot String
+  depositRoot String
+  migrationRoot String
+}
+
+model Bootstrap {
+  id String @id @default(uuid())
+  blockHash String? @unique
+  utxoTreeIndex Int
+  // utxoBootstrap String[]
+  utxoBootstrap String // jsonified arr : sqlite does not support arr
+  withdrawalTreeIndex Int
+  // withdrawalBootstrap String[]
+  withdrawalBootstrap String //jsonified arr : sqlite does not support arr
+  block Block? @relation(fields: [blockHash], references: [hash])
+}
+
+model MassDeposit {
+  index String @id
+  merged String
+  fee String
+  blockNumber Int
+  includedIn String?
+}
+
+model Deposit {
+  note String @id
+  fee String
+  transactionIndex Int
+  logIndex Int
+  blockNumber Int
+  queuedAt String
+}
+
+model Nullifier {
+  index String @id
+  nullified Boolean
+}
+
+model Note {
+  hash String @id
+  index String?
+  eth String?
+  pubKey String?
+  salt String?
+  tokenAddr String?
+  erc20Amount String?
+  nft String?
+  type Int?
+  withdrawOutTo String?
+  fee String?
+  status Int?
+  noteType Int
+  treeId String?
+  tree LightTree? @relation(fields: [treeId], references: [id])
+}
+
+model TreeNode {
+  treeId String
+  nodeIndex String
+  value String
+  // tree UtxoTree @relation(fields: [treeId], references: [id])
+  @@id([treeId, nodeIndex])
+}
+
+model LightTree {
+  id String @default(uuid()) @unique
+  species Int // 0: utxo 1: withdrawal
+  treeIndex Int
+  block String?
+  // rollup sync data
+  start String
+  end String
+  // rollup snapshot data
+  root String
+  index String
+  siblings String // stringified str[]
+  @@id([species, treeIndex])
+}
+
+model NullifierTree {
+  id String @id @default(uuid())
+  treeIndex Int @unique
+  block String?
+  root String
+  siblings String // stringified str[]
+}
```


