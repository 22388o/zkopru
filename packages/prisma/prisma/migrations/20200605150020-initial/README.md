# Migration `20200605150020-initial`

This migration has been generated by Wanseob Lim at 6/5/2020, 3:00:20 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
PRAGMA foreign_keys=OFF;

CREATE TABLE "quaint"."EncryptedWallet" (
"N" INTEGER NOT NULL  ,"algorithm" TEXT NOT NULL  ,"ciphertext" TEXT NOT NULL  ,"id" TEXT NOT NULL  ,"iv" TEXT NOT NULL  ,"kdf" TEXT NOT NULL  ,"keylen" INTEGER NOT NULL  ,"p" INTEGER NOT NULL  ,"r" INTEGER NOT NULL  ,"salt" TEXT NOT NULL  ,
    PRIMARY KEY ("id"))

CREATE TABLE "quaint"."Keystore" (
"address" TEXT NOT NULL  ,"encrypted" TEXT NOT NULL  ,"pubKey" TEXT NOT NULL  ,
    PRIMARY KEY ("address"))

CREATE TABLE "quaint"."Config" (
"address" TEXT NOT NULL  ,"chainId" INTEGER NOT NULL  ,"challengePeriod" INTEGER NOT NULL  ,"id" TEXT NOT NULL  ,"maxUtxoPerTree" TEXT NOT NULL  ,"maxWithdrawalPerTree" TEXT NOT NULL  ,"minimumStake" TEXT NOT NULL  ,"networkId" INTEGER NOT NULL  ,"nullifierTreeDepth" INTEGER NOT NULL  ,"referenceDepth" INTEGER NOT NULL  ,"txoTreeDepth" INTEGER NOT NULL  ,"utxoSubTreeDepth" INTEGER NOT NULL  ,"utxoSubTreeSize" INTEGER NOT NULL  ,"withdrawalSubTreeDepth" INTEGER NOT NULL  ,"withdrawalSubTreeSize" INTEGER NOT NULL  ,"withdrawalTreeDepth" INTEGER NOT NULL  ,
    PRIMARY KEY ("id"),FOREIGN KEY ("id") REFERENCES "ZkOPRUChain"("id") ON DELETE CASCADE ON UPDATE CASCADE)

CREATE TABLE "quaint"."ZkOPRUChain" (
"id" TEXT NOT NULL  ,
    PRIMARY KEY ("id"))

CREATE TABLE "quaint"."Block" (
"chainId" TEXT   ,"hash" TEXT NOT NULL  ,"proposalData" TEXT NOT NULL  ,"proposalNum" INTEGER NOT NULL  ,"proposalTx" TEXT NOT NULL  ,"proposedAt" INTEGER NOT NULL  ,"status" INTEGER NOT NULL  ,
    PRIMARY KEY ("hash"),FOREIGN KEY ("hash") REFERENCES "Header"("hash") ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY ("hash") REFERENCES "Bootstrap"("hash") ON DELETE CASCADE ON UPDATE CASCADE,
FOREIGN KEY ("chainId") REFERENCES "ZkOPRUChain"("id") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."Header" (
"challengePeriod" INTEGER NOT NULL  ,"hash" TEXT NOT NULL  ,"maxUtxoPerTree" TEXT NOT NULL  ,"maxWithdrawalPerTree" TEXT NOT NULL  ,"minimumStake" TEXT NOT NULL  ,"nullifierTreeDepth" INTEGER NOT NULL  ,"referenceDepth" INTEGER NOT NULL  ,"txoTreeDepth" INTEGER NOT NULL  ,"utxoSubTreeDepth" INTEGER NOT NULL  ,"utxoSubTreeSize" INTEGER NOT NULL  ,"withdrawalSubTreeDepth" INTEGER NOT NULL  ,"withdrawalSubTreeSize" INTEGER NOT NULL  ,"withdrawalTreeDepth" INTEGER NOT NULL  ,
    PRIMARY KEY ("hash"))

CREATE TABLE "quaint"."Bootstrap" (
"hash" TEXT NOT NULL  ,"utxoBootstrap" TEXT NOT NULL  ,"utxoTreeIndex" INTEGER NOT NULL  ,"withdrawalBootstrap" TEXT NOT NULL  ,"withdrawalTreeIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("hash"))

CREATE TABLE "quaint"."MassDeposit" (
"blockNumber" INTEGER NOT NULL  ,"fee" TEXT NOT NULL  ,"includedIn" TEXT   ,"index" TEXT NOT NULL  ,"merged" TEXT NOT NULL  ,
    PRIMARY KEY ("index"),FOREIGN KEY ("includedIn") REFERENCES "Block"("hash") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."Deposit" (
"blockNumber" INTEGER NOT NULL  ,"fee" TEXT NOT NULL  ,"includedIn" TEXT   ,"logIndex" INTEGER NOT NULL  ,"note" TEXT NOT NULL  ,"queuedAt" TEXT   ,"transactionIndex" INTEGER NOT NULL  ,
    PRIMARY KEY ("note"),FOREIGN KEY ("queuedAt") REFERENCES "MassDeposit"("index") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."Nullifier" (
"blockHash" TEXT NOT NULL  ,"index" TEXT NOT NULL  ,"nullified" BOOLEAN NOT NULL  ,
    PRIMARY KEY ("index"))

CREATE TABLE "quaint"."Note" (
"erc20Amount" TEXT   ,"eth" TEXT   ,"fee" TEXT   ,"hash" TEXT NOT NULL  ,"index" TEXT   ,"nft" TEXT   ,"pubKey" TEXT   ,"salt" TEXT   ,"status" INTEGER   ,"tokenAddr" TEXT   ,"treeId" TEXT   ,"type" INTEGER   ,"withdrawOutTo" TEXT   ,
    PRIMARY KEY ("hash"),FOREIGN KEY ("treeId") REFERENCES "LightTree"("id") ON DELETE SET NULL ON UPDATE CASCADE)

CREATE TABLE "quaint"."TreeNode" (
"nodeIndex" TEXT NOT NULL  ,"treeId" TEXT NOT NULL  ,"value" TEXT NOT NULL  ,
    PRIMARY KEY ("treeId","nodeIndex"))

CREATE TABLE "quaint"."LightTree" (
"block" TEXT   ,"end" TEXT NOT NULL  ,"id" TEXT NOT NULL  ,"index" TEXT NOT NULL  ,"root" TEXT NOT NULL  ,"siblings" TEXT NOT NULL  ,"species" INTEGER NOT NULL  ,"start" TEXT NOT NULL  ,"treeIndex" INTEGER NOT NULL  ,"zkopru" TEXT NOT NULL  ,
    PRIMARY KEY ("id"),FOREIGN KEY ("zkopru") REFERENCES "ZkOPRUChain"("id") ON DELETE CASCADE ON UPDATE CASCADE)

CREATE TABLE "quaint"."NullifierTree" (
"block" TEXT   ,"id" TEXT NOT NULL  ,"root" TEXT NOT NULL  ,"siblings" TEXT NOT NULL  ,"treeIndex" INTEGER NOT NULL  ,"zkopru" TEXT NOT NULL  ,
    PRIMARY KEY ("id"),FOREIGN KEY ("zkopru") REFERENCES "ZkOPRUChain"("id") ON DELETE CASCADE ON UPDATE CASCADE)

CREATE UNIQUE INDEX "quaint"."Config_id" ON "Config"("id")

CREATE  INDEX "quaint"."LightTree.species_treeIndex" ON "LightTree"("species","treeIndex")

CREATE UNIQUE INDEX "quaint"."NullifierTree.treeIndex" ON "NullifierTree"("treeIndex")

CREATE UNIQUE INDEX "quaint"."NullifierTree_zkopru" ON "NullifierTree"("zkopru")

PRAGMA "quaint".foreign_key_check;

PRAGMA foreign_keys=ON;
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200605150020-initial
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,179 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource sqlite {
+  provider = "sqlite"
+  url      = env("DATABASE_URL")
+}
+
+//  datasource posgres {
+//    provider = "postgres"
+//    url      = env("POSTGRES_URL")
+//  }
+
+model EncryptedWallet {
+  id String @id @default(uuid())
+  ciphertext String
+  iv String
+  algorithm String
+  keylen Int
+  kdf String
+  N Int
+  r Int
+  p Int
+  salt String
+}
+
+model Keystore {
+  address String @id
+  pubKey String
+  encrypted String // stringified json
+}
+
+model Config {
+  id String @id @default(uuid())
+  networkId Int
+  chainId Int
+  address String
+  txoTreeDepth Int
+  withdrawalTreeDepth Int
+  nullifierTreeDepth Int
+  challengePeriod Int
+  minimumStake String
+  referenceDepth Int
+  maxUtxoPerTree String
+  maxWithdrawalPerTree String
+  utxoSubTreeDepth Int
+  utxoSubTreeSize Int
+  withdrawalSubTreeDepth Int
+  withdrawalSubTreeSize Int
+  chain ZkOPRUChain @relation(fields: [id], references: [id])
+}
+
+model ZkOPRUChain {
+  id String @id @default(uuid())
+  config Config?
+  nullifierTree NullifierTree
+  // utxoTrees UtxoTree[]
+  // withdrawalTrees WithdrawalTree[]
+  blocks Block[]
+}
+
+model Block {
+  hash String @id
+  header Header @relation(fields: [hash], references: [hash])
+  status Int // NOT_FETCHED = 0 / FETCHED = 1 / PARTIALLY_VERIFEID = 2 / FULLY_VERIFIED = 3 / FINALIZED = 4 / INVALIDATED = 5 / REVERTED = 6
+  proposalNum Int
+  proposedAt Int
+  proposalTx String // tx hash
+  proposalData String // stringified json
+  bootstrap Bootstrap @relation(fields: [hash], references: [hash])
+  chainId String?
+  chain ZkOPRUChain? @relation(fields: [chainId], references: [id])
+}
+
+model Header {
+  hash String @id
+  txoTreeDepth Int
+  withdrawalTreeDepth Int
+  nullifierTreeDepth Int
+  challengePeriod Int
+  minimumStake String
+  referenceDepth Int
+  maxUtxoPerTree String
+  maxWithdrawalPerTree String
+  utxoSubTreeDepth Int
+  utxoSubTreeSize Int
+  withdrawalSubTreeDepth Int
+  withdrawalSubTreeSize Int
+}
+
+model Bootstrap {
+  hash String @id
+  utxoTreeIndex Int
+  // utxoBootstrap String[]
+  utxoBootstrap String // jsonified arr : sqlite does not support arr
+  withdrawalTreeIndex Int
+  // withdrawalBootstrap String[]
+  withdrawalBootstrap String //jsonified arr : sqlite does not support arr
+}
+
+model MassDeposit {
+  index String @id
+  merged String
+  fee String
+  blockNumber Int
+  includedIn String?
+  block Block? @relation(fields: [includedIn], references: [hash])
+  deposits Deposit[]
+}
+
+model Deposit {
+  note String @id
+  fee String
+  transactionIndex Int
+  logIndex Int
+  blockNumber Int
+  queuedAt String?
+  includedIn String?
+  massDeposit MassDeposit? @relation(fields: [queuedAt], references: [index])
+}
+
+model Nullifier {
+  index String @id
+  nullified Boolean
+  blockHash String
+}
+
+model Note {
+  hash String @id
+  index String?
+  eth String?
+  pubKey String?
+  salt String?
+  tokenAddr String?
+  erc20Amount String?
+  nft String?
+  type Int?
+  withdrawOutTo String?
+  fee String?
+  status Int?
+  treeId String?
+  tree LightTree? @relation(fields: [treeId], references: [id])
+}
+
+model TreeNode {
+  treeId String
+  nodeIndex String
+  value String
+  // tree UtxoTree @relation(fields: [treeId], references: [id])
+  @@id([treeId, nodeIndex])
+}
+
+model LightTree {
+  id String @id @default(uuid())
+  species Int // 0: utxo 1: withdrawal
+  treeIndex Int
+  zkopru String
+  block String?
+  // rollup sync data
+  start String
+  end String
+  // rollup snapshot data
+  root String
+  index String
+  siblings String // stringified str[]
+  chain ZkOPRUChain @relation(fields: [zkopru], references: [id])
+  @@index([species, treeIndex])
+}
+
+model NullifierTree {
+  id String @id @default(uuid())
+  zkopru String
+  treeIndex Int @unique
+  block String?
+  root String
+  siblings String // stringified str[]
+  chain ZkOPRUChain @relation(fields: [zkopru], references: [id])
+}
```


